@startuml

package "Engine" {

    class Engine {
        -database : IDatabase
        +execute_query(query : String) : IExecutionResult
        +start_server(server : IInternetServer)
        +stop_server()
    }

    package Server {
        interface IInternetServer {
            +start()
            +stop()
            +set_engine(engine : Engine)
        }

        class TcpServer {
            -engine : Engine
            -port : int
            -running : bool
            +start()
            +stop()
            +handle_client()
            +process_request(query : String) : IExecutionResult
        }
        TcpServer ..|> IInternetServer
        Engine.Engine <.. IInternetServer : uses
        TcpServer ..> Engine.Engine : calls execute_query()

        class ClientSession {
            -engine : Engine&
            -socket : TcpSocket
            -server : TcpServer
            +run()
            +receive_query() : String
            +send_result(result : IExecutionResult)
        }
        TcpServer --> ClientSession : creates
        ClientSession --> Engine.Engine : execute_query()
    }
    interface IDatabase {
        +execute_query(query : String) : IExecutionResult
    }
    IDatabase ..> Engine

    class StdDatabase {
        -db_config : Configuration

        -parser : SqlParser
        -analyzer : SemanticAnalyzer
        -planner : QueryPlanner
        -executor : PlanExecutor
        -storage : StdStorage
        +execute_query(query : String) : IExecutionResult
    }
    StdDatabase <.. "Parser"
    StdDatabase <.. "Executor"
    StdDatabase <.. Storage.IStorage

    StdDatabase ..|> IDatabase

    package "Parser" {
        class SqlParser {
            -tokens : List<SqlToken>
            -current : int
            +parse(query : String) : AstNode

            -parse_select() : SelectStatement
            -parse_insert() : InsertStatement
            -parse_update() : UpdateStatement
            -parse_delete() : DeleteStatement
            -parse_create_table() : CreateTableStatement
            -parse_create_db() : CreateDbStatement
            -parse_binary() : BinaryExpr
            -parse_column_def() : ColumnDefinition
        }
    }

    package "Executor" {
        class QueryPlanner {
            +plan(node : AstNode) : QueryPlan
            -plan_select(stmt : SelectStatement) : QueryPlan
            -plan_insert(stmt : SelectStatement) : QueryPlan
            -plan_update(stmt : SelectStatement) : QueryPlan
            -plan_delete(stmt : SelectStatement) : QueryPlan
        }

        class SemanticAnalyzer {
            +analyze(node : AstNode) : AnalysisResult
            -analyze_select(stmt : SelectStatement) : AnalysisResult
            -analyze_insert(stmt : InsertStatement) : AnalysisResult
            -analyze_update(stmt : UpdateStatement) : AnalysisResult
            -analyze_delete(stmt : DeleteStatement) : AnalysisResult
        }

        class PlanExecutor {
            +execute(plan : QueryPlan) : IExecutionResult
            -execute_select(plan : QueryPlan) : IExecutionResult
            -execute_insert(plan : QueryPlan) : IExecutionResult
            -execute_update(plan : QueryPlan) : IExecutionResult
            -execute_delete(plan : QueryPlan) : IExecutionResult
        }
    }

    package "Storage" {
        interface IStorage {
            +begin_txn() : Transaction

            +get_table(table_name : String, schema_name : String) : MetaTable
            +get_schema(schema_name : String) : MetaSchema

            +seq_scan(table : MetaTable) : DataTable
            +index_scan(index : MetaIndex ) : DataTable
            +insert_row(row: DataRow, txn : Transaction)
            +update_row(old: DataRow, new: DataRow, txn : Transaction)

            +commit_txn(txn : Transaction)
        }

        class StdStorage {
            -data_buffers : DataBuffers
            -wal_manager : WalManager
            -io_manager : IOManager

            +begin_txn() : Transaction

            +get_table(table_name : String, schema_name : String) : MetaTable
            +get_schema(schema_name : String) : MetaSchema

            +seq_scan(table : MetaTable) : DataTable
            +index_scan(index : MetaIndex ) : DataTable
            +insert_row(row: DataRow, txn : Transaction)
            +update_row(old: DataRow, new: DataRow, txn : Transaction)

            +commit_txn(txn : Transaction)
        }
        StdStorage ..|> IStorage

        class Catalog {
            -io_manager : IOManager&
            +get_table(table_name : String, schema_name : String) : MetaTable
            +get_schema(schema_name : String) : MetaSchema
            +save_table(table : MetaTable)
            +save_schema(schema : MetaSchema)
        }
        Catalog ..> StdStorage
        Catalog <.. IOManager

        interface IOManager {
            +write_page(page : DataPage)
            +read_page(id : uuid)

            +read_table_meta(name : String)
            +write_table_meta(table : MetaTable)

            +read_schema_meta(name : String)
            +write_schema_meta(schema : MetaSchema)
        }

        class FileIOManager {
            -data_path : std::filesystem::path
            +write_page(page : DataPage)
            +read_page(id : uuid)

            +read_table_meta(name : String)
            +write_table_meta(table : MetaTable)

            +read_schema_meta(name : String)
            +write_schema_meta(schema : MetaSchema)
        }
        IOManager <|.. FileIOManager

        class DataBuffers {
            -pages : List<DataPage>
            -io_manager : IOManager&

            +get_page(id : uuid) : DataPage&
            +get_available_page(free_space : uint64_t) : DataPage&
            +create_page() : DataPage&
            +flush()
        }
        DataBuffers <.. IOManager

        StdStorage <.. DataBuffers
        StdStorage <.. Transaction

        class Transaction {
            id : uuid
            logs : List<IWalLog>
        }
    }
}
@enduml